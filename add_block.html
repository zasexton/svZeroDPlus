<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>svZeroDSolver: Adding New Blocks</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">svZeroDSolver
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Adding New Blocks</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Below are details on the steps required to implement a new block in svZeroDSolver.</p>
<p><em>Note: The best way to implement a new block is to look at examples of existing block classes. See the <code><a class="el" href="class_valve_tanh.html" title="Valve (tanh) block.">ValveTanh</a></code> class for an example.</em></p>
<h2>1. Name the new block.</h2>
<ul>
<li>The name should then be added to the following lists/dictionaries:<ul>
<li><code><a class="el" href="_block_type_8h.html#a54420623f26ab6bb61042b41cccf37a3" title="The types of blocks supported by the solver.">BlockType</a></code> in <a class="el" href="_block_type_8h.html" title="Specifies the types of blocks and their parameters.">src/model/BlockType.h</a></li>
<li><code>block_factory_map</code> in src/model/Model.cpp</li>
<li><em>Note: In <code>block_factory_map</code>, the dictionary key should match the string specifying the type of block in the <code>.json</code> configuration/input file, and the dictionary value should match the class constructor name for the block.</em></li>
<li>If the new block requires special handling that is different from the current blocks (most new blocks do not), add a new category to <code><a class="el" href="_block_type_8h.html#aef4629c3f968cbb691cddca5b9d3e950" title="The classes/categories of blocks supported. Some classes require special handling (e....">BlockClass</a></code> in <a class="el" href="_block_type_8h.html" title="Specifies the types of blocks and their parameters.">src/model/BlockType.h</a></li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h2>2. Create a class for the new block.</h2>
<h3>Class constructor</h3>
<ul>
<li>The new class will be inherited from <code><a class="el" href="class_block.html" title="Base class for 0D model components.">Block</a></code>. Define a constructor of the form: <div class="fragment"><div class="line">MyNewBlock(int id, Model *model) </div>
<div class="line">: Block(id, model, BlockType::block_type, BlockClass::block_class,</div>
<div class="line">{{Param_1, InputParameter()}, </div>
<div class="line">{Param_2, InputParameter()}, </div>
<div class="line">..., </div>
<div class="line">{Param_N, InputParameter()}}) {}</div>
</div><!-- fragment --><ul>
<li><code>MyNewBlock</code> is the name of the new class</li>
<li><code>block_type</code> and <code>block_class</code> are the same as what was added in Step 1 above.</li>
<li>The names of the input parameters of the block are <code>Param_1</code>, ... , <code>Param_N</code>.</li>
<li>The properties of each parameter are defined by <code><a class="el" href="struct_input_parameter.html" title="Handles the properties of input parameters.">InputParameter</a></code>, which specifies whether it is optional, an array, a scalar, a function, and its default value.</li>
<li>The names <code>Param_1</code>, ... , <code>Param_N</code> must be the same as the parameter names within the block definition in the <code>.json</code> configuration/input file.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h3>Set up the degrees of freedom</h3>
<ul>
<li>The class must have a <code>setup_dofs(<a class="el" href="class_d_o_f_handler.html" title="Degree-of-freedom handler.">DOFHandler</a> &amp;dofhandler)</code> function.<ul>
<li>This function typically only includes a call to the following function: <div class="fragment"><div class="line">Block::setup_dofs_(DOFHandler &amp;dofhandler, int num_equations, const std::list&lt;std::string&gt; &amp;internal_var_names)</div>
</div><!-- fragment --></li>
<li>In the above function, <code>num_equations</code> is the number of governing equations for the new block.</li>
<li><code>internal_var_names</code> is a list of strings that specify names for variables that are internal to the block, i.e. all variables for the block apart from the flow and pressure at the block's inlets and outlets.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h3>Other class members</h3>
<ul>
<li>The class should have a <code><a class="el" href="struct_triplets_contributions.html" title="The number of triplets that the element contributes to the global system.">TripletsContributions</a> num_triplets{*, *, *}</code> object.<ul>
<li>This specifies how many elements the governing equations of the block contribute to the global <code>F</code>, <code>E</code> and <code>dC_dy</code> matrices respectively.</li>
<li>Details are in Step 3 below.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<ul>
<li>The class should have an <code>update_constant</code> function and may also contain <code>update_time</code> and <code>update_solution</code> functions. These functions implement the governing equations for the block. Details are in Steps 3-4 below.</li>
</ul>
<p><br  />
 </p>
<ul>
<li><em>Optional:</em> The class can have an <code>enum ParamId</code> object that relates the parameter indices to their names.<ul>
<li>This makes it easier to reference the parameters while implementing the governing equations of the block (discussed below).</li>
<li>The order of parameters in the <code>ParamId</code> object should match the order in the constructor.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h2>3. Set up the governing equations for the block.</h2>
<h3><a class="el" href="class_state.html" title="State of the system.">State</a> vector</h3>
<ul>
<li>The local state vector for each block is always arranged as <code>y = [P_in, Q_in, P_out, Q_out, InternalVariable_1, ..., InternalVariable_N]</code>. <br  />
<ul>
<li>Here, <code>InternalVariable*</code> refers to any variable in the governing equations that are not the inlet and outlet flow and pressure. These are the same as those discussed above in the function <code>setup_dofs</code>.</li>
<li>The corresponding time-derivative of this state vector is <code>ydot = dP_in/dt, dQ_in/dt, ...]</code>.</li>
<li><em>Note: The length of the state vector is typically four (inlet and outlet pressure and flow) plus the number of internal variables.</em></li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h3>Governing equations</h3>
<ul>
<li>The equations should be written in the form <code>E(t)*ydot + F(t)*y + C(y,ydot,t) = 0</code>.<ul>
<li><code>y</code> is the local state vector mentioned above.</li>
<li><code>ydot</code> is the time-derivative of the local state vector.</li>
<li><code>E</code> and <code>F</code> are matrices of size <code>number_of_equations*size_of_state_vector</code>.</li>
<li><code>C</code> is a vector of length <code>number_of_equations</code>.</li>
<li><code>E</code> and <code>F</code> contain terms of the governing equation that multiply the respective components of <code>ydot</code> and <code>y</code> respectively.</li>
<li><code>C</code> contains all non-linear and constant terms in the equation.</li>
<li>If the equation contains non-linear terms, the developer should also write out the derivative of <code>C</code> with respect to <code>y</code> and <code>ydot</code>. These will be stored in the block's <code>dC_dy</code> and <code>dC_dydot</code> matrices, both of which are size <code>number_of_equations*size_of_state_vector</code>.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h3>An example</h3>
<ul>
<li><p class="startli">Assume a block has the following non-linear governing equations:</p>
<p class="startli"><picture><source srcset="form_126_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$ a \frac{dQ_{in}}{dt} + b P_{in} + c \frac{dP_{in}}{dt} Q_{in} + d = 0 $" src="form_126.png" width="270" height="26"/></picture></p>
<p class="startli"><picture><source srcset="form_127_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$ e \frac{dP_{out}}{dt} + f Q_{out} Q_{out} + g P_{out} + h I_{1} = 0 $" src="form_127.png" width="311" height="26"/></picture></p><ul>
<li>For this block, <picture><source srcset="form_128_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$P_{in}$" src="form_128.png" width="26" height="19"/></picture> and <picture><source srcset="form_129_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$Q_{in}$" src="form_129.png" width="28" height="19"/></picture> are the pressure and flow at the inlet respectively, <picture><source srcset="form_130_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$P_{out}$" src="form_130.png" width="34" height="19"/></picture> and <picture><source srcset="form_131_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$Q_{out}$" src="form_131.png" width="36" height="19"/></picture> are the pressure and flow at the outlet, and <picture><source srcset="form_132_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$I_{1}$" src="form_132.png" width="17" height="19"/></picture> is an internal variable.</li>
<li>The state vector is <picture><source srcset="form_133_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$[P_{in}, Q_{in}, P_{out}, Q_{out}, I_{1}]$" src="form_133.png" width="188" height="21"/></picture>.</li>
<li>The contributions to the local <code>F</code> matrix are <code>F[0,0] = b</code>, <code>F[1,2] = g</code> and <code>F[1,4] = h</code>.</li>
<li>The contributions to the local <code>E</code> matrix are <code>E[0,1] = a</code> and <code>E[1,2] = e</code>.</li>
<li>The contributions to the local <code>C</code> vector are <code>C[0] = c*(dP_in/dt)*Q_in + d</code> and <code>C[1] = f*Q_out*Q_out</code>.</li>
<li>The contributions to the local <code>dC_dy</code> matrix are <code>dC_dy[0,1] = c*(dP_in/dt)</code> and <code>dC_dy[1,3] = 2*f*Q_out</code>.</li>
<li>The contributions to the local <code>dC_dydot</code> matrix are <code>dC_dydot[0,0] = c*Q_in</code>.</li>
<li>In this case, the block has 3 contributions to <code>F</code>, 2 contributions to <code>E</code>, and 2 constributions to <code>dC_dy</code>. So the class will have a member <code><a class="el" href="struct_triplets_contributions.html" title="The number of triplets that the element contributes to the global system.">TripletsContributions</a> num_triplets{3, 2, 2}</code>.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h2>4. Implement the matrix equations for the block.</h2>
<ul>
<li>Implement the <code>update_constant</code>, <code>update_time</code> and <code>update_solution</code> functions.<ul>
<li>All matrix elements that are constant must be specified in <code>update_constant</code>.</li>
<li>Matrix elements that depend only on time (not the state variables) must be specified in <code>update_time</code>.</li>
<li>Matrix elements that change with the solution (i.e. depend on the state variables themselves) must be specified in <code>update_solution</code>.</li>
<li><em>Note: Not all blocks will require the <code>update_time</code> and <code>update_solution</code> functions.</em></li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h3>Implementation details</h3>
<ul>
<li>The elements of the matrices <code>E</code>, <code>F</code>, <code>dC_dy</code> and <code>dC_dydot</code> are populated using the following syntax: <br  />
 <div class="fragment"><div class="line">system.F.coeffRef(global_eqn_ids[current_block_equation_id], global_var_ids[current_block_variable_ids]) = a</div>
</div><!-- fragment --><ul>
<li>Here, <code>current_block_equation_id</code> goes from 0 to <code>number_of_equations-1</code> (for the current block) and <code>current_block_variable_ids</code> goes from 0 to <code>size_of_state_vector-1</code> for the current block.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<ul>
<li>If the governing equations contain non-linear terms, these terms must be specified in <code>update_solution</code> as: <div class="fragment"><div class="line">system.C(global_eqn_ids[current_block_equation_id]) = non_linear_term</div>
</div><!-- fragment --></li>
</ul>
<p><br  />
 </p>
<ul>
<li>For non-linear equations, the derivative of the terms in <code>C</code> with respect to each state variable <code>y</code> and <code>ydot</code> must also be provided. These go into <code>dC_dy</code> and <code>dC_dydot</code> matrices.<ul>
<li>A <code>dC_dy</code> matrix contribution can be specified using the following syntax: <div class="fragment"><div class="line">system.dC_dy.coeffRef(global_eqn_ids[current_block_equation_id], global_var_ids[current_block_variable_id]) = a</div>
</div><!-- fragment --></li>
<li>Here, <code>a</code> is the derivative of the non-linear term in the equation with ID <code>current_block_equation_id</code> with respect to the local state variable with ID <code>current_block_variable_id</code>.</li>
<li>For example, if the non-linear term is in the first equation, then <code>current_block_equation_id = 0</code>.</li>
<li>For the derivative of this term with respect to <code>P_in</code>, set <code>current_block_variable_id = 0</code>, and for the derivative of this term with respect to <code>P_out</code>, set <code>current_block_variable_id = 2</code>.</li>
<li>The same indexing applies to derivatives with respect to the <code>ydot</code> state variables, i.e. for the derivative of the term with respect to <code>dP_in/dt</code>, set <code>current_block_variable_id = 0</code>.</li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<ul>
<li><em>Note: Any matrix and vector components that are not specified are 0 by default.</em></li>
</ul>
<p><br  />
 </p>
<h2>4. Add the new block to the build system.</h2>
<ul>
<li>Add <code>MyNewBlock.h</code> and <code>MyNewBlock.cpp</code> to <code>src/model/CMakeLists.txt</code></li>
</ul>
<p><br  />
 </p>
<h2>5. Add the new block to svZeroDVisualization.</h2>
<ul>
<li>Follow the instructions <a class="el" href="visualization.html">here</a> to make sure your new block can be visualized graphically. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
